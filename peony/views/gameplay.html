<div class="viewContent" style="background-image: url('assets/shop1/p2.png');">
	<div class="npcLayer" style="display: none;"></div>
	<div class="shop-pre"></div>
	<div class="shop-post"></div>
	<button class="imageButton" id="trayButton" style="bottom:32px;left:32px;background:url('assets/common/addItem.png')" onclick="_f.game.toggleTray();"></button>
	<div class="moneyHud"><div class="moneyIcon"></div><div class="moneyText"></div></div>
</div>

<script>

_f.music.changeBGM('game');

var widthPre = sizeOf('peony/assets/shop1/p1.png').width;
$('.shop-pre').css('min-width', widthPre).css('max-width', widthPre).css('background-image', 'url("assets/shop1/p1.png")');

var widthPost = sizeOf('peony/assets/shop1/p3.png').width;
$('.shop-post').css('min-width', widthPost).css('max-width', widthPost).css('background-image', 'url("assets/shop1/p3.png")');

$('.viewContent').css('min-width', gameSave.shopWidth+widthPost+widthPre+'px');
$('.viewContent').css('max-width', gameSave.shopWidth+widthPost+widthPre+'px');
$('.viewContent').css('background-position-x', widthPre+'px');

_f.game.updateMoneyHud();

gameSave.shop.forEach(function(res){
	if(res.shouldDraw) {
		$('.viewContent').append('<div class="item" style="width: '+res.dimensions[0]+'px; height: '+res.dimensions[1]+'px; top: '+res.position[1]+'px; left: '+res.position[0]+'px; position: absolute; background: url(\''+res.image+'\')" id="item-'+res.uuid+'"></div>');
	}

	res.destroy = function(){_f.game.destroyItem(this.uuid);};
	res.interaction = itemDefinitions[res.id].interaction;
	res.sell = function(){_f.game.sellItem(this.uuid);};
	res.flip = function(){_f.game.flipItem(this.uuid);};

	if(res.flipped == 1) {
		$('#item-'+res.uuid).css('transform', 'scaleX(-1)');
	}

});

$('.content').mousewheel(function(e, delta) {
    $(this).scrollLeft(this.scrollLeft + (-delta * 40));
    e.preventDefault();
});

$('li').on('click', function(res) {
	$('.trayOptions ul li').removeClass('active');
	$('#'+res.target.id).addClass('active');
	$('.trayView').hide();
	$('#trayView-'+res.target.id).show();
})


$(document).on("contextmenu", ".item", function(e){

	var itemReference = _f.game.getItemFromUUID(e.target.id.substring(5));
	var sellPrice = (itemReference.price / 4 )* 3;
	var menu = new gui.Menu();
	menu.append(new gui.MenuItem({ label: itemReference.name, enabled: false}));
	if(itemReference.canMove) {
		menu.append(new gui.MenuItem({ type: 'separator' }));
		menu.append(new gui.MenuItem({ label: 'Flip', click: function(){
			itemReference.flip();
		}}));
		menu.append(new gui.MenuItem({ label: 'Move', click: function(){
			_f.game.moveItem(e.target.id.substring(5));
		} }));
	}
	if(itemReference.price > 0) {
		menu.append(new gui.MenuItem({ type: 'separator' }));
		menu.append(new gui.MenuItem({ label: 'Sell ($'+sellPrice.toFixed(2)+')', click: function(){itemReference.sell();}}));
	}
	console.log(e);
	menu.popup(e.pageX, e.pageY);
	return false;
});

if(!gameSave.tutorialComplete) {
	$('.moneyHud').hide();
	$('.imageButton').hide();
	setTimeout(function(){_f.game.npcSpeech('manvir', [0, 1, 2], function(){
		setTimeout(function(){
			/* run this after 1s */
			_f.game.npcSpeech('manvir', [3, 4], function(){
				_f.ui.modal.push("Well? What are you going to call your shop?", "<p>Be careful picking this - you won't be able to change it later!</p><input type=\"text\" id=\"name\" name=\"name\"></input>", [
					{
						"name": "OK",
						"action": "_f.ui.modal.dismiss(updateShopNameAndContinueTutorial);"
					}
				]);
			});
		}, 3000);
	})}, 500); /* run this after 500ms */
}

function updateShopNameAndContinueTutorial() {
	gameSave.shopName = $('#name').val();
	_f.system.save();
	_f.game.npcSpeech('manvir', [5, 6, 7], function() {
		$('.imageButton').attr('onclick', '');
		$('.imageButton').show();
		$('.imageButton').on('click', function(){
			_f.game.npcSpeech('manvir', [8], function(){
				$('.imageButton').hide();
				_f.game.toggleTray(function(){

					$('.itemElement').attr('onclick', '');
					$('.itemElement').on('click', function() {

						_f.game.confirmBuy(0);
						$('.buyButton').attr('onclick', '');
						$('.buyButton').on('click', function() {
							_f.game.toggleTray(function(){
								_f.game.purchaseItem(0, true);
								setTimeout(function(){
									_f.game.npcSpeech('manvir', [9], function(){

									});
								}, 500);
							})

						});

					});

				});

			});
		});
	})
}


</script>
