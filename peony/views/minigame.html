<div class="viewContent">
	<div class="beanSelect">
		<button id="beans0" class="beans beans0"></button>
		<button id="beans1" class="beans beans1"></button>
		<button id="beans2" class="beans beans2"></button>
		<button id="beans3" class="beans beans3"></button>
	</div>
	<div class="beanGrind">
		<div class="counter">10</div>
		<div class="beanGrindBean">

		</div>
		<div class="progress-bar"></div>
	</div>
	<div class="cupSize">
		<button id="cup0" class="cup cup0"></button>
		<button id="cup1" class="cup cup1"></button>
		<button id="cup2" class="cup cup2"></button>
	</div>
	<div class="milking">
		<div class="udder">

		</div>
		<div class="cupMilk cupMilk0"></div>
	</div>
	<div class="flavouring">
		<button id="flavour0" class="flavour"></button>
		<button id="flavour1" class="flavour"></button>
		<button id="flavour2" class="flavour"></button>
		<button id="flavour3" class="flavour"></button>
		<button id="flavour4" class="flavour"></button>
		<button id="flavour5" class="flavour"></button>
	</div>
</div>

<link href="views/minigame.css" type="text/css" rel="stylesheet">

<script>

	var minigameScores = {
		"beans": false,
		"grind": false,
		"size": false,
		"milk": false,
		"flavouring": [false, false, false, false, false, false]
	}

	_f.music.changeBGM('minigame');

	$('.beans').on('click', function(e){
		minigameScores.beans = e.toElement.id.substring(5);
		$('.beanSelect').fadeOut(500, function(){
			$('.beanGrind').fadeIn(500, function(){
				var grindBar = setInterval(function(){
					if($('.progress-bar').width() > 0) {
						$('.progress-bar').width($('.progress-bar').width()-1);
					} else if($('.progress-bar').width() < 0) {
						$('.progress-bar').width(0);
					}
				}, 10)
				var counter = setInterval(function(){
					$('.counter').text( parseInt($('.counter').text())-1 );
				}, 1000);
				setTimeout(function(){
					clearInterval(grindBar);
					clearInterval(counter);
					minigameScores.grind = ($('.progress-bar').width() / 1770) * 100;
					$('.beanGrind').fadeOut(500, function(){
						$('.cupSize').fadeIn(500);
					})
				}, 10000);
			});
		});
	});

	$('.beanGrindBean').on('click', function(){
		_f.music.playSFX('grind');

		if($('.progress-bar').width()+100 < 1770) {
			$('.progress-bar').width($('.progress-bar').width()+100);
		} else {
			$('.progress-bar').width(1770);
		}
	});

	$('.cup').on('click', function(e) {
		cupSize = e.toElement.id.substring(3);
		minigameScores.size = cupSize;
		$('.cupSize').fadeOut(500, function(){
			$('.milking').fadeIn(500, function(){
				milkAmount = 0;
				expectedButtonPress = 0;
				/* this is used in the milking minigame to determine which key press is expected.
				the player must press up and down repeatedly until the coffee has the right amount of milk,
				then press enter to accept. to determine which button needs to be pressed next, this var is used.
				0 = up is expected, 1 = down is expected. this is changed to the opposite value after the expected
				key is pressed */

				$(document).keydown(function(e) {
				    switch(e.which) {
			        	case 38: {
							// up pressed
							if(expectedButtonPress === 0) {
								// only run this code if up was expected.
								expectedButtonPress = 1; /* now down is expected */
							}
							break;
						}

				        case 40: {
							// down pressed
							if(expectedButtonPress == 1) {
								// only run this code if down was expected.
								_f.music.playSFX('milk'); // play the milking sound effect
								milkAmount += 0.02; // changes the amount of milk.
								if(milkAmount >= 1) {
									milkAmount = 1; // 100% is the maximum amount of milk
								}
								// the possible milk percentages go up in 10%s (i.e. 0%, 10%, 20%, ..., 100%)
								// therefore we need to round milkAmount DOWN and convert it into a percentage.
								var milkPercentage = (Math.floor(10 * milkAmount) / 10).toFixed(1)*100;
								minigameScores.milk = milkPercentage;
								// based on the milk percentage, we'll change the sprite that's displayed to the user.
								$('.cupMilk').attr('class','').addClass('cupMilk cupMilk'+milkPercentage);
								expectedButtonPress = 0; /* now up is expected */
							}
							break;
						}

						case 13: {
							// enter pressed
							$(document).off(); /* disables key bindings added in last minigame */
							$('.milking').fadeOut(500, function(){
								$('.flavouring').fadeIn(500, function(){

									$('.flavour').on('click', function(e){
										flavourType = e.toElement.id.substring(7);
										$('#'+e.toElement.id).css('background-color', '#222222').css('opacity', 1);
											/* #222222 is the background color, so this basically hides the button */
										minigameScores.flavouring[flavourType] = true;
									})


									$(document).keydown(function(e) {
										switch(e.which) {
											case 13: {
												// coffee made, go back to gameplay view and pass the scores object
												_f.music.playSFX('coffee-end');
												_f.views.loadView('gameplay');
											}
										}
										e.preventDefault();
									});

								})
							})
						}
				    }
				    e.preventDefault();
				});

			})
		})
	});
</script>
